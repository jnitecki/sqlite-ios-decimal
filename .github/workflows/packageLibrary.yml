name: Package iOS lib as XCFramework

on:
  push:
    tags:
      - 'v*'  # publish on tag, e.g. v1.2.3
  workflow_dispatch:  # also allow manual runs
    inputs:
      SQLITE_VERSION:
        type: string
        description: "SQLite version to use"
        required: false
        default: ""

jobs:
  package:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build for devices (iphoneos)
        run: |
          xcodebuild -project sqlite-ios-decimal.xcodeproj \
            -scheme sqlite-ios-decimal \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$PWD/build/ios" \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            OTHER_CFLAGS="-fembed-bitcode" \
            SYMROOT="build" \
            ARCHS="arm64" \
            ONLY_ACTIVE_ARCH=NO \
            SQLITE_VERSION="${{ github.event.inputs.SQLITE_VERSION }}" \
            | tee ${{ github.workspace }}/build_iphoneos.log

      - name: Get SQLite version
        id: sqlite_version
        run: |
            SQLITE_VERSION=$(grep -Eo "SQLITE_VERSION=[0-9]+\\.[0-9]+\\.[0-9]+" ${{ github.workspace }}/build_iphoneos.log \
              | grep -Eo "[0-9]+\\.[0-9]+\\.[0-9]+" \
              | head -n1)
            echo "SQLITE_VERSION=$SQLITE_VERSION" >> $GITHUB_OUTPUT

      - name: Get SQLite headers directory and copy module.modulemap there
        id: sqlite_headers
        run: |
            SQLITE_HEADERS=$(grep -Eo "SQLITE_HEADERS=.*" ${{ github.workspace }}/build_iphoneos.log \
              | head -n1 \
              | sed -E -e 's/^SQLITE_HEADERS[[:space:]]*=[[:space:]]*//' -e 's/[[:space:]]*$//' -e 's/^"//' -e 's/"$//')
            cp SQLite-Decimal/module.modulemap "$SQLITE_HEADERS"
            echo "SQLITE_HEADERS=$SQLITE_HEADERS" >> $GITHUB_OUTPUT            

      - name: Build for simulator (iphonesimulator)
        run: |
          xcodebuild -project sqlite-ios-decimal.xcodeproj \
            -scheme sqlite-ios-decimal \
            -configuration Release \
            -destination "generic/platform=iOS Simulator" \
            -archivePath "$PWD/build/ios-sim" \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            SYMROOT="build" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            SQLITE_VERSION='${{ steps.sqlite_version.outputs.SQLITE_VERSION }}'

      - name: Create XCFramework (device + simulator)
        run: |
          xcrun xcodebuild -create-xcframework \
            -library build/Release-iphoneos/libsqlite-ios-decimal.a \
            -headers ${{ steps.sqlite_headers.outputs.SQLITE_HEADERS }} \
            -library build/Release-iphonesimulator/libsqlite-ios-decimal.a \
            -headers ${{ steps.sqlite_headers.outputs.SQLITE_HEADERS }} \
            -output sqlite-ios-decimal.xcframework

      - name: Package XCFramework
        run: |
          mkdir -p artifacts
          zip -r artifacts/sqlite-ios-decimal.xcframework.zip sqlite-ios-decimal.xcframework

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SQLite-Decimal-xcframework
          path: artifacts/sqlite-ios-decimal.xcframework.zip

      - name: Create GitHub Release (optional)
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: SQLite Decimal ${{ github.ref_name }}
          artifacts: artifacts/sqlite-ios-decimal.xcframework.zip
